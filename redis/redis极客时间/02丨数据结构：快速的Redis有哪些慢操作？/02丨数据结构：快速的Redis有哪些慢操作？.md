## **键和值用什么结构组织**

1、为了快速从键到值快速访问，Redis 使用了一个哈希表来保存所有键值对。一个哈希表，其实就是一个数组，数组的每个元素成为一个哈希桶。哈希桶中的元素保存的并不是值本身，而是指向具体值的指针。

![alt 属性文本](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/全局哈希表.png)

2、哈希冲突

1. **链式哈希**，就是指同一个哈希中的多个元素用一个链表来保存，
    ![image-20211026142029901](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/链式哈希.png)

2. 渐进式 **rehash** Redis 默认使用两个全局哈希表：哈希表1 和哈希表2 。一开始，默认使用哈希表1，插入数据，哈希表2 并没有被分配空间。随着数据开始增多， Redis 开始执行 rehash，这个过程分为三步

   1. 给哈希表 2 分配更大的空间，例如说当前哈希表 1大小的两倍；

   2. 把哈希表1 中的数据重新映射并拷贝到哈希表2 中；
   3. 释放哈希表1 的空间。

   而原理的哈希表1 留作下一次 rehash扩容备用。

   第二步拷贝数据时，Redis每处理一个请求时，从哈希表1 中的第一个索引位置开始，顺带着将这个索引位置上的所有 entries拷贝到哈希表2 中，以此类推。

![alt 属性文本](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/渐进式 rehash.png)



## 有哪些底层数据结构？

1、集合类型的底层数据结构主要有5 种：整数数组、双向链表、哈希表、压缩列表和跳表。

2、压缩链表在表头有三个字段 zlbytes、zltail和zllen，分别表示列表长度、列表尾的偏移量和列表中的 entry 个数；表尾还有一个 zlend，表示列表结束。

![image-20211026110005907](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/压缩链表.png)

3、跳表
![image-20211026110942529](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/跳表.png)

4、数据结构时间复杂度
![image-20211026111122456](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/时间复杂度.png)



## 不同操作的复杂度

1、“四句口诀”，快速记住集合常见操作的复杂度。可以规避搞复杂的操作

. 单元素操作是基础；
. 范围操作非常耗时；
. 统计操作通常高效；
. 例外情况只有两个。
第一，**单元素操作，是指每一种集合类型对单个数据实现的增删改查操作**。
Hash 类型的 HGET、HSET 和 HDEL，Set 类型的 SADD、SREM、SRANDMEMBER。这些操作的复杂度由它们底层采用的数据结构决定。
例如，HGET、HSET 和 HDEL 是对哈希表做操作，所以复杂度都是 O(1)；
Set 类型用哈希表作为底层数据结构时  SADD、SREM、SRANDMEMBER 复杂度为 O(1)
第二，**范围操作，是指集合类型中的遍历操作，可以返回集合中的所有数据**
例如，Hash 的 HEGETALL 和 Set 类型的 SMEMBERS，或者返回一个范围内的部分数据，例如 List 类型的 LRANGE 和 ZSet 类型的 ZRANGE。**这类操作的复杂度一般是 O(N)，比较耗时，应该尽量避免**。
Redis 从2.8版本开始提供了 SCAN 系统操作，这类操作实现了渐进式遍历，每次值返回有限的数据。
第三，统计操作，是指集合类型对集合中所有元素个数的记录，例如 LLEN 和 SCARD，这类操作复杂度只有 O(1)。
第四，例外情况，是指某些数据结构的特殊记录，例如**压缩列表和双向链表都会记录表头和表尾的偏移量**。例如 List 类型的 LPOP、RPOP、LPUSH、RPUSH 这四个操作。O(1)

## 小结

![image-20211026141809194](/Users/Rthena/Desktop/redis极客时间/02丨数据结构：快速的Redis有哪些慢操作？/小结.png)
