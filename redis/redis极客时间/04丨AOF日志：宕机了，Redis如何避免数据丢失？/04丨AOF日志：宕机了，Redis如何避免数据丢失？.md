## AOF 日志是如何实现的？（AOF是主线程执行的）

![image-20211026161402241](/Users/Rthena/Desktop/redis极客时间/04丨AOF日志：宕机了，Redis如何避免数据丢失？/Redis AOF操作过程.png)

1、写后日志
AOF 为什么要先执行命令再记录日志呢？
为了避免额外的检测开销，Redis 在向 AOF 里面记录日志的时候，并不会先去对这些命令进行语法检查。所以，如果先记录日志再执行命令的话，日志中就有可能记录了错误的命令，Redis 在使用日志恢复数据时，就可能出错。实际上 Redis 会把出错日志删掉。

## 三种写回策略

![image-20211026163639488](/Users/Rthena/Desktop/redis极客时间/04丨AOF日志：宕机了，Redis如何避免数据丢失？/AOF落盘的三种策略.png)

文件太大带来了性能问题。一是，文件系统本身对文件大小有限制，无法保存过大的文件；二是，文件太大，再往里面追加命令记录的话，效率也会变低；三是，如果发生宕机，AOF 中记录的命令要一个个被重新执行，用于故障恢复，如果日志文件太大，整个恢复过程就会非常缓慢。

**AOF 重写机制**登场

## 日志文件太大了怎么办？

“多变一”功能，详情请看我的AOF持久化机制

## AOF 重写会阻塞吗？

重写过程是由后台 bgwriteaof 来完成。

**一个拷贝，两处日志** 

![image-20211026165720082](/Users/Rthena/Desktop/redis极客时间/04丨AOF日志：宕机了，Redis如何避免数据丢失？/AOF非阻塞的重写过程.png)

## Question

1、重写过程有没有其他潜在的阻塞风险？
	a. fork 子进程，fork 这个瞬间一定会阻塞主线程。
2、AOF 重写也有一个重写日志，为什么它不共享使用 AOF 本身的日子呢？